<!DOCTYPE html>
<html lang="en" class="h-full bg-slate-950">
  <head>
    <meta charset="UTF-8" />
    <title>Shop — Old Dog Systems</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <meta
      name="description"
      content="Unified shop for Old Dog Systems products, courses, journals, and the Rough Diamond Studio."
    />
    <script src="https://cdn.tailwindcss.com?plugins=typography,forms"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <link rel="stylesheet" href="./styles.css" />
    <script type="module">
      import { applyBranding } from './constants.js';
      window.addEventListener('DOMContentLoaded', () => {
        applyBranding();
      });
    </script>
  </head>
  <body class="h-full text-slate-100 antialiased">
    <div class="min-h-screen flex flex-col">
      <!-- Navigation -->
      <header
        class="sticky top-0 z-40 border-b border-slate-800/80 bg-slate-950/70 backdrop-blur-xl"
      >
        <nav class="nav-glass mx-auto flex max-w-6xl items-center justify-between px-4 py-3 mt-2 rounded-2xl">
          <div class="flex items-center gap-3">
            <a href="./index.html" class="flex items-center gap-3">
              <img
                src="./images/Dog 5.png"
                alt="Old Dog Systems Logo"
                class="h-12 w-12 rounded-xl object-cover border border-slate-700/60"
              />
              <div class="flex flex-col">
                <span
                  data-brand
                  class="text-sm font-semibold tracking-tight text-slate-100"
                ></span>
                <span class="text-[11px] uppercase tracking-[0.18em] text-slate-500"
                  >Old Dog · New Tricks</span
                >
              </div>
            </a>
          </div>

          <!-- Desktop nav -->
          <div class="hidden items-center gap-8 text-sm font-medium text-slate-200 md:flex">
            <a href="./index.html" class="nav-underline">Home</a>
            <a href="./media.html" class="nav-underline">Media House</a>
            <a href="./studio.html" class="nav-underline">Studio</a>
            <a href="./shop.html" class="nav-underline" aria-current="page">Shop</a>
            <a href="./dashboard.html" class="nav-underline">Dashboard</a>
            <a href="./studio.html#alpha-access" class="nav-underline">Alpha Access</a>
          </div>

          <!-- Mobile trigger -->
          <button
            type="button"
            class="inline-flex items-center justify-center rounded-full border border-slate-700/70 p-2 text-slate-200 md:hidden"
            aria-label="Open navigation"
            onclick="document.getElementById('mobile-nav').classList.toggle('hidden')"
          >
            <span class="block h-0.5 w-4 rounded-full bg-slate-200 mb-0.5"></span>
            <span class="block h-0.5 w-4 rounded-full bg-slate-400 mb-0.5"></span>
            <span class="block h-0.5 w-3 rounded-full bg-slate-500"></span>
          </button>
        </nav>

        <!-- Mobile nav -->
        <div id="mobile-nav" class="mx-auto mt-2 hidden max-w-6xl px-4 pb-3 md:hidden">
          <div class="nav-glass rounded-2xl p-4 text-sm text-slate-100 space-y-3">
            <a href="./index.html" class="block">Home</a>
            <a href="./media.html" class="block">Media House</a>
            <a href="./studio.html" class="block">Rough Diamond Studio</a>
            <a href="./shop.html" class="block" aria-current="page">Shop</a>
            <a href="./dashboard.html" class="block">Dashboard</a>
            <a href="./studio.html#alpha-access" class="block">Alpha Access</a>
          </div>
        </div>
      </header>

      <!-- Main -->
      <main class="flex-1">
        <!-- Hero -->
        <section class="relative overflow-hidden">
          <div class="absolute inset-0 hero-grid pointer-events-none"></div>
          <div class="relative mx-auto flex max-w-6xl flex-col gap-6 px-4 py-16 sm:py-20">
            <div>
              <p class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-400">
                Unified Shop
              </p>
              <h1 class="mt-2 text-4xl font-semibold tracking-tight text-slate-50 sm:text-5xl">
                Products, courses & tools for operators.
              </h1>
              <p class="mt-4 max-w-2xl text-sm text-slate-400 sm:text-base">
                Everything from podcast companions to the <span data-brand></span> studio tools. Built for founders and operators who ship weekly.
              </p>
            </div>

            <!-- Cart indicator button -->
            <div class="flex items-center gap-2">
              <button
                onclick="document.getElementById('cart-section').scrollIntoView({behavior: 'smooth'})"
                id="cart-indicator"
                class="rounded-full border border-slate-700 bg-slate-900/70 px-4 py-2 text-sm font-medium text-slate-100 hover:border-emerald-500 transition-colors"
              >
                <span id="cart-count" class="inline-block mr-2 font-bold text-emerald-400">0</span>items in cart
              </button>
            </div>

            <!-- Filter Tabs -->
            <div class="flex flex-wrap gap-2">
              <button data-filter="all" class="filter-btn active px-4 py-2 rounded-full border border-slate-700 bg-slate-900/70 text-sm font-medium text-slate-100 hover:border-sky-500 transition-colors">
                All Products
              </button>
              <button data-filter="software" class="filter-btn px-4 py-2 rounded-full border border-slate-700 bg-slate-900/70 text-sm font-medium text-slate-100 hover:border-sky-500 transition-colors">
                Software
              </button>
              <button data-filter="media" class="filter-btn px-4 py-2 rounded-full border border-slate-700 bg-slate-900/70 text-sm font-medium text-slate-100 hover:border-sky-500 transition-colors">
                Podcast Resources
              </button>
            </div>
          </div>
        </section>

        <!-- Products Grid -->
        <section class="border-t border-slate-800/80 bg-slate-950/50">
          <div class="mx-auto max-w-6xl px-4 py-16 sm:py-20">
            <!-- Active Products -->
            <div class="mb-16">
              <h2 class="mb-8 text-2xl font-semibold text-slate-50">Featured Products</h2>
              <div id="products-grid" class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
                <!-- Products loaded here via JavaScript -->
              </div>
            </div>

            <!-- Coming Soon -->
            <div id="coming-soon-section" class="pt-12 border-t border-slate-700/50">
              <h2 class="mb-8 text-2xl font-semibold text-slate-50">Coming Soon</h2>
              <div id="coming-soon-grid" class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
                <!-- Coming soon products loaded here -->
              </div>
            </div>
          </div>
        </section>

        <!-- Cart Summary -->
        <section id="cart-section" class="border-t border-slate-800/80 bg-slate-950/95">
          <div class="mx-auto max-w-2xl px-4 py-16 sm:py-20">
            <h2 class="mb-8 text-2xl font-semibold text-slate-50">Your Cart</h2>
            
            <div id="cart-empty" class="rounded-2xl border border-slate-700/50 p-8 text-center">
              <p class="text-slate-400">Your cart is empty. Browse our products above.</p>
            </div>

            <div id="cart-items" class="hidden space-y-4">
              <!-- Cart items rendered here -->
            </div>

            <div id="cart-total" class="hidden mt-8 rounded-2xl border border-slate-700/50 p-6 space-y-4">
              <div class="flex justify-between text-lg font-semibold">
                <span>Total:</span>
                <span id="cart-total-price">$0.00</span>
              </div>
              <button
                id="checkout-btn"
                class="w-full rounded-lg bg-sky-500 px-6 py-3 text-lg font-medium text-slate-950 shadow-lg shadow-sky-500/30 hover:bg-sky-400 transition-colors"
              >
                Proceed to Checkout
              </button>
              <button
                id="clear-cart-btn"
                class="w-full rounded-lg border border-slate-700 bg-slate-900/70 px-6 py-3 text-sm font-medium text-slate-200 hover:border-slate-500 transition-colors"
              >
                Clear Cart
              </button>
            </div>
          </div>
        </section>
      </main>

      <footer class="border-t border-slate-800/80 py-6">
        <div
          class="mx-auto flex max-w-6xl flex-col items-center justify-between gap-3 px-4 text-xs text-slate-500 sm:flex-row"
        >
          <p>
            © <span id="year"></span>
            <span data-brand></span>. All rights reserved.
          </p>
          <div class="flex items-center gap-4">
            <a href="./shop.html" class="hover:text-slate-300">Shop</a>
            <a href="./index.html#about" class="hover:text-slate-300">About</a>
            <a href="./studio.html#alpha-access" class="hover:text-slate-300">Contact</a>
          </div>
        </div>
      </footer>
    </div>

    <!-- Quick View Modal -->
    <div id="modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur">
      <div class="relative max-w-lg w-full mx-4 rounded-2xl border border-slate-700/60 bg-slate-900 p-6 sm:p-8 card-glass">
        <button
          onclick="document.getElementById('modal').classList.add('hidden')"
          class="absolute top-4 right-4 text-slate-400 hover:text-slate-200"
        >
          ✕
        </button>
        <div id="modal-content">
          <!-- Modal content loaded here -->
        </div>
      </div>
    </div>

    <script>
      // App state
      let allProducts = [];
      let cart = JSON.parse(localStorage.getItem('cart') || '[]');
      let currentFilter = 'all';

      // Initialize
      document.addEventListener('DOMContentLoaded', async () => {
        document.getElementById('year').textContent = new Date().getFullYear();
        await loadProducts();
        renderProducts();
        renderCart();
        setupEventListeners();
      });

      // Load products from API
      async function loadProducts() {
        try {
          const response = await fetch('/api/products');
          const data = await response.json();
          allProducts = data.products || [];
        } catch (error) {
          console.error('Failed to load products:', error);
          // Fallback to dummy data
          allProducts = [];
        }
      }

      // Render products
      function renderProducts() {
        const grid = document.getElementById('products-grid');
        const comingSoonGrid = document.getElementById('coming-soon-grid');
        const comingSoonSection = document.getElementById('coming-soon-section');
        const filtered = filterProducts();
        
        // Separate active and coming-soon products
        const activeProducts = filtered.filter(p => p.status === 'active');
        const comingSoonProducts = filtered.filter(p => p.status === 'coming-soon');
        
        // Render active products
        grid.innerHTML = activeProducts
          .map(p => `
            <div class="group card-glass rounded-2xl border border-slate-700/60 p-6 hover:border-sky-500/60 transition-colors">
              <div class="mb-3 flex items-start justify-between">
                <div>
                  <p class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-400 mb-1">
                    ${p.category}
                  </p>
                  <h3 class="text-lg font-semibold text-slate-50">${p.name}</h3>
                </div>
                ${p.status === 'alpha' ? '<span class="rounded-full bg-emerald-500/10 px-2 py-0.5 text-xs text-emerald-300">Alpha</span>' : ''}
              </div>
              <p class="text-sm text-slate-400 mb-4">${p.description}</p>
              
              <div class="space-y-3">
                <div class="text-2xl font-bold text-sky-400">${p.displayPrice}</div>
                <button
                  onclick="addToCart(${JSON.stringify(p).replace(/"/g, '&quot;')})"
                  class="w-full rounded-lg bg-sky-500 px-4 py-2 text-sm font-medium text-slate-950 hover:bg-sky-400 transition-colors"
                >
                  Add to Cart
                </button>
                <button
                  onclick="showModal(${JSON.stringify(p).replace(/"/g, '&quot;')})"
                  class="w-full rounded-lg border border-slate-700 bg-transparent px-4 py-2 text-sm font-medium text-slate-200 hover:border-slate-500 transition-colors"
                >
                  View Details
                </button>
              </div>
            </div>
          `).join('');
        
        // Render coming-soon products
        if (comingSoonProducts.length > 0) {
          comingSoonSection.classList.remove('hidden');
          comingSoonGrid.innerHTML = comingSoonProducts
            .map(p => `
              <div class="group card-glass rounded-2xl border border-slate-700/60 p-6 opacity-60">
                <div class="mb-3 flex items-start justify-between">
                  <div>
                    <p class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-400 mb-1">
                      ${p.category}
                    </p>
                    <h3 class="text-lg font-semibold text-slate-50">${p.name}</h3>
                  </div>
                  <span class="rounded-full bg-slate-500/10 px-2 py-0.5 text-xs text-slate-400">Coming Soon</span>
                </div>
                <p class="text-sm text-slate-400 mb-4">${p.description}</p>
                <div class="text-2xl font-bold text-slate-400">${p.displayPrice}</div>
              </div>
            `).join('');
        } else {
          comingSoonSection.classList.add('hidden');
        }
      }

      // Filter products
      function filterProducts() {
        if (currentFilter === 'all') return allProducts;
        return allProducts.filter(p => p.category === currentFilter);
      }

      // Add to cart
      function addToCart(product) {
        const existing = cart.find(item => item.id === product.id);
        if (existing) {
          existing.quantity = (existing.quantity || 1) + 1;
        } else {
          cart.push({ ...product, quantity: 1 });
        }
        localStorage.setItem('cart', JSON.stringify(cart));
        renderCart();
      }

      // Render cart
      function renderCart() {
        // Update cart count indicator
        document.getElementById('cart-count').textContent = cart.length;
        
        if (cart.length === 0) {
          document.getElementById('cart-empty').classList.remove('hidden');
          document.getElementById('cart-items').classList.add('hidden');
          document.getElementById('cart-total').classList.add('hidden');
        } else {
          document.getElementById('cart-empty').classList.add('hidden');
          document.getElementById('cart-items').classList.remove('hidden');
          document.getElementById('cart-total').classList.remove('hidden');

          document.getElementById('cart-items').innerHTML = cart.map(item => `
            <div class="flex justify-between items-center p-4 rounded-lg border border-slate-700/50 bg-slate-900/50">
              <div>
                <p class="font-medium text-slate-100">${item.name}</p>
                <p class="text-sm text-slate-400">${item.displayPrice}</p>
              </div>
              <div class="flex items-center gap-3">
                <input
                  type="number"
                  min="1"
                  value="${item.quantity}"
                  onchange="updateQuantity('${item.id}', this.value)"
                  class="w-12 px-2 py-1 rounded border border-slate-600 bg-slate-800 text-slate-100 text-center"
                />
                <button
                  onclick="removeFromCart('${item.id}')"
                  class="text-red-400 hover:text-red-300"
                >
                  Remove
                </button>
              </div>
            </div>
          `).join('');

          const total = cart.reduce((sum, item) => sum + (item.price * (item.quantity || 1)), 0);
          document.getElementById('cart-total-price').textContent = `$${(total / 100).toFixed(2)}`;
        }
      }

      // Update quantity
      function updateQuantity(productId, quantity) {
        const item = cart.find(i => i.id === productId);
        if (item) {
          item.quantity = parseInt(quantity) || 1;
          localStorage.setItem('cart', JSON.stringify(cart));
          renderCart();
        }
      }

      // Remove from cart
      function removeFromCart(productId) {
        cart = cart.filter(i => i.id !== productId);
        localStorage.setItem('cart', JSON.stringify(cart));
        renderCart();
      }

      // Show modal
      function showModal(product) {
        const html = `
          <h2 class="text-2xl font-bold mb-2">${product.name}</h2>
          <p class="text-sm text-slate-400 mb-4">${product.category}</p>
          <p class="text-slate-300 mb-4">${product.longDescription}</p>
          <div class="mb-4">
            <p class="font-semibold text-slate-200 mb-2">Features:</p>
            <ul class="space-y-1">
              ${product.features.map(f => `<li class="text-sm text-slate-400">• ${f}</li>`).join('')}
            </ul>
          </div>
          <div class="text-3xl font-bold text-sky-400 mb-4">${product.displayPrice}</div>
          <button
            onclick="addToCart(${JSON.stringify(product).replace(/"/g, '&quot;')}); document.getElementById('modal').classList.add('hidden');"
            class="w-full rounded-lg bg-sky-500 px-4 py-3 text-lg font-medium text-slate-950 hover:bg-sky-400 transition-colors"
          >
            Add to Cart
          </button>
        `;
        document.getElementById('modal-content').innerHTML = html;
        document.getElementById('modal').classList.remove('hidden');
      }

      // Checkout
      document.getElementById('checkout-btn')?.addEventListener('click', async () => {
        const email = prompt('Enter your email:');
        if (!email) return;

        try {
          const response = await fetch('/api/checkout', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ items: cart, customerEmail: email })
          });
          const { sessionId } = await response.json();
          
          // Redirect to Stripe checkout
          const stripe = Stripe('pk_test_your_key_here'); // Set real key from env
          await stripe.redirectToCheckout({ sessionId });
        } catch (error) {
          alert('Checkout failed: ' + error.message);
        }
      });

      // Clear cart
      document.getElementById('clear-cart-btn')?.addEventListener('click', () => {
        cart = [];
        localStorage.removeItem('cart');
        renderCart();
      });

      // Setup filter buttons
      function setupEventListeners() {
        document.querySelectorAll('.filter-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            // Remove active class from all buttons
            document.querySelectorAll('.filter-btn').forEach(b => {
              b.classList.remove('active');
            });
            // Add active class to clicked button
            e.currentTarget.classList.add('active');
            // Update current filter
            currentFilter = e.currentTarget.dataset.filter;
            // Re-render products
            renderProducts();
          });
        });
        
        // Set initial active state
        const allBtn = document.querySelector('[data-filter="all"]');
        if (allBtn) {
          allBtn.classList.add('active');
        }
      }
    </script>
  </body>
</html>
